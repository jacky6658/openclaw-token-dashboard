# ⚠️ Dashboard 資料問題 - 完整修復方案

> 目前狀況：資料庫沒有數據、Gateway 未運行偵測錯誤

---

## 🔍 已發現的問題

### 1. 資料庫欄位不匹配 ✅ 已修復
```
錯誤：查詢 quota_percent（不存在）
正確：應查詢 quota_remaining_pct
```

### 2. 資料庫沒有數據
```
token_usage 表：0 筆記錄
model_quota 表：12 筆記錄（已有）
```

### 3. Gateway 偵測問題 ✅ 已修復
```
錯誤：檢查錯誤的進程名
正確：使用 pgrep -f "openclaw-gateway"
```

### 4. 數據收集未自動執行
```
需要手動執行或設定 cron job
```

---

## ✅ 已完成的修復

1. ✅ 修正資料庫查詢欄位名
2. ✅ 修正 Gateway 偵測邏輯  
3. ✅ 創建「收集數據.command」工具
4. ✅ 優化啟動器自動啟動 Gateway
5. ✅ 手動執行數據收集（已有 12 筆模型配額）

---

## 🚀 立即修復步驟

### 步驟 1：重新啟動 Dashboard（使用修復後的代碼）

```bash
雙擊「啟動 Dashboard.command」
```

### 步驟 2：啟動 Gateway（如果未運行）

```bash
# 方法一：使用工具
雙擊「檢查並啟動 Gateway.command」

# 方法二：終端機
openclaw gateway start
```

### 步驟 3：等待數據產生

```
使用 OpenClaw 執行一些查詢
例如：在 Telegram 與 Bot 對話
```

### 步驟 4：收集數據

```bash
# 手動收集
雙擊「收集數據.command」

# 或設定自動收集（推薦）
雙擊「收集數據.command」→ 選擇「啟用自動收集」
```

### 步驟 5：刷新 Dashboard

```
在瀏覽器按 Cmd + Shift + R 強制刷新
```

---

## 📊 為什麼沒有數據？

### 原因分析

**Token 用量數據（token_usage 表）：**
```
來源：OpenClaw 實際使用記錄
條件：需要執行過 AI 查詢
狀態：0 筆 = 尚未使用過或未收集

解決：使用 OpenClaw 後再收集數據
```

**模型配額數據（model_quota 表）：**
```
來源：openclaw models 命令
條件：Gateway 運行
狀態：12 筆 ✅ 已有數據

解決：已完成，可顯示模型狀態
```

---

## 🔧 完整修復後的功能

### 現在可以正常使用

✅ **模型頁面**
```
顯示 12 個模型的配額狀態
• google-antigravity/gemini-2.5-flash-thinking: 100%
• google-antigravity/gemini-3-pro-image: 100%
• google-gemini-cli/Pro: 100%
• google-gemini-cli/Flash: 100%
• openai-codex/5h: 100%
• openai-codex/Day: 0% (Cooldown)
• 等等...
```

✅ **Gateway 狀態**
```
正確偵測 Gateway 是否運行
不再誤報「未運行」
```

### 暫時無數據（正常）

⚠️ **總覽頁面**
```
顯示：今日/週/月 用量 = 0
原因：尚未有使用記錄
```

⚠️ **歷史頁面**
```
顯示：無歷史數據
原因：資料庫空的
```

⚠️ **成本頁面**
```
顯示：成本 = $0
原因：無用量記錄
```

---

## 💡 快速測試

### 驗證修復是否成功

```bash
# 1. 重啟 Dashboard
雙擊「啟動 Dashboard.command」

# 2. 開啟瀏覽器
http://localhost:3737

# 3. 點擊「模型」頁籤
應該看到 12 個模型及其配額

# 4. 查看頂部控制面板
應該看到正確的 Gateway 狀態
```

---

## 📋 產生數據的方法

### 方法一：使用 Telegram Bot

```
1. 在 Telegram 與您的 OpenClaw Bot 對話
2. 執行幾個查詢
3. 等待 5-10 分鐘
4. 雙擊「收集數據.command」
5. 刷新 Dashboard
```

### 方法二：使用 CLI

```bash
# 1. 執行一些 OpenClaw 命令
echo "請幫我寫一個 Python 函數" | openclaw chat

# 2. 收集數據
cd /Users/user/clawd/projects/token-dashboard
node backend/collector/collect.js

# 3. 刷新 Dashboard
```

### 方法三：自動收集（推薦）

```bash
# 設定每 5 分鐘自動收集
雙擊「收集數據.command」
→ 選擇「啟用自動收集」

# 之後會自動：
• 每 5 分鐘收集一次
• 數據自動更新到 Dashboard
• 無需手動操作
```

---

## ✅ 檢查清單

- [x] 修正資料庫查詢欄位
- [x] 修正 Gateway 偵測
- [x] 手動收集模型配額數據
- [x] 創建數據收集工具
- [x] Gateway 已啟動
- [ ] 等待產生使用數據（需要實際使用）
- [ ] 設定自動收集（可選）

---

## 🎉 現在請執行

```bash
# 1. 停止所有舊的 Dashboard
已自動清理

# 2. 重新啟動
雙擊「啟動 Dashboard.command」

# 3. 檢查模型頁面
應該能看到 12 個模型的配額了！

# 4. 如果要看到用量數據
使用 OpenClaw → 收集數據 → 刷新
```

---

**所有問題已修復！現在重新啟動 Dashboard 即可！** 🚀✨
